{% extends "layout.html" %}
{% block head_extra %}

<script type="text/javascript">
  function EnvoyerNouveauMembre() {
    request_data = {};

    request_data.prenom = $('#ajoutprenom').val();
    request_data.nom = $('#ajoutnom').val();
    request_data.courriel = $('#ajoutcourriel').val();
    request_data.provenance = $('#ajoutprovenance').val();
    request_data.listedenvoi = ($('#ajoutlistedenvoi').prop('checked')) ? 'oui' : 'non';
  
    $.ajax({
      url: '/api/membres',
      type: 'POST',
      data: request_data,
      dataType: 'json',
    }).done(function (data) {
      if (data.status == 'ok') {
        $('#ajoutmembre').dialog('close');
        AfficherInfo('Membre ' + request_data.prenom + ' ' + request_data.nom + ' (#' + data.numero + ') ajouté.');
        RechargerListeMembres();
      } else {
        AfficherErreur('Erreur: ' + data.errorstr);
      }
    }).fail(function () {
      AfficherErreur('Erreur...');
    });
  }

  function InitialiserTableauMembres() {
    $('#membres').dataTable({
      'aaData': null,
      'bJQueryUI': true,
      'bLengthChange': false,
      'iDisplayLength': 20,
      'oLanguage': {
         sLengthMenu: "afficher _MENU_ entrées par page",
         sZeroRecords: "désolé, aucun résultat trouvé...",
         sInfo: "_START_ à _END_ de _TOTAL_ entrées",
         sInfoEmpty: "0 à 0 d'aucune entrée",
         sInfoFiltered: "(filtré de _MAX_ entrées en tout)",
         sSearch: "rechercher&nbsp;:"
       }
    });
  }

  // Considerer utiliser dataTables' mDataProp
  function RemplirTableauMembres(json_data) {
    tableau = $('#membres');
    tableau.dataTable().fnClearTable();
    
    colonnes = []

    membres = new Array();
    $('#membres th').each(function(i) {
      
      colonnes.push({
        source: $(this).attr('data-column'),
        transform: $(this).attr('data-transform'),
      });
    });
    
    liste_prenoms = {};

    for (i in json_data) {
      
      infos = json_data[i];

      if ('prenom' in infos) {
        liste_prenoms[infos.prenom] = 1;
      }
      membre = new Array();

      for (col in colonnes) {
        colname = colonnes[col].source;
        transform = colonnes[col].transform;

        if (colname in infos) {
          valeur = infos[colname];
          if (transform && transform in window && typeof(window[transform] == "function")) {
            valeur = window[transform](valeur);
          }
          membre.push(valeur);
        } else {
          membre.push('?');
        }
      }

      membres.push(membre);
    }
   
    tableau.dataTable().fnAddData(membres);

    $('#loading').hide();
    $('#membres tbody tr').click(function() {

      // TODO: trouver une meilleure solution pour aller chercher le numero...
      numero = $(this).find('td').html();
      location.href = ('/membres/' + numero);
    });
    $('#membres').show();
    $('#membres_wrapper').show();
    
    // Pour l'autocomplete des prenoms;
    $('#ajoutprenom').autocomplete({
      source: Object.keys(liste_prenoms).sort(),
      minLength: 0,
      delay: 0,
    }).focus(function() {
      $('#ajoutprenom').autocomplete('search');
    });
  }

  function Majusculer(valeur) {
    return valeur.charAt(0).toUpperCase() + valeur.slice(1);
  }

  function RechargerListeMembres() {
    $('#membres').hide();
    $('#membres_wrapper').hide();
    $('#loading').show();
    $.ajax({
      url: '/api/membres',
      dataType: 'json',
    }).done(function(data) {
      RemplirTableauMembres(data);
    }).fail(function() {
      AfficherErreur('Erreur lors du téléchargement de la liste de membres...');
    });
  }

  $(document).ready(function () {

    $('#boutonajoutmembre').button();
    $('#boutonajoutmembre').click(function () {
      $('#ajoutmembre').dialog('open');
    });

    $('#ajoutmembre').dialog({
      'autoOpen': false,
      'modal': true,
      'height': 'auto',
      'width': 900,
      'title': 'Nouveau membre',
      'draggable': false,
      'resizable': false,
    });

    $('input[type="text"][data-default]').each(function (i) {
      defval = $(this).attr('data-default');
      $(this).val(defval);
      $(this).addClass('input-with-default');

      $(this).focus(function () {
        defval = $(this).attr('data-default');
        if ($(this).val() == defval) {
          $(this).val('');
          $(this).removeClass('input-with-default');
        }
      });

      $(this).blur(function () {
        if (!$(this).val()) {
          defval = $(this).attr('data-default');
          $(this).val(defval);
          $(this).addClass('input-with-default');
        }
      });
    });

    $('#typeabonnement').buttonset();
    
    $('#ajoutprovenance').autocomplete({
      source: ['Poly', 'UdeM', 'HEC'],
      minLength: 0,
      delay: 0,
    }).focus(function() {
      $('#ajoutprovenance').autocomplete('search');
    });

    $('#ajoutlistedenvoi').button().change(function() {
      if ($(this).prop('checked')) {
        $('label[for=ajoutlistedenvoi] span').text('Ajouter à la liste d\'envoi: oui');
      } else {
        $('label[for=ajoutlistedenvoi] span').text('Ajouter à la liste d\'envoi: non');
      }
    });
    $('#ajoutenvoyer').button().click(function (event) {
      event.preventDefault();
      EnvoyerNouveauMembre();
    });
  
    InitialiserTableauMembres();
    RechargerListeMembres();
  });
</script>

{% endblock %}
{% block content %}
  <h1>Liste des membres</h1>
  <div style="margin-bottom: 20px">
    <input type="button" value="Nouveau membre" id="boutonajoutmembre" />
  </div>
  <div id="ajoutmembre">
    <form id="formulaireajoutmembre">
      <p>
        <input type="text" id="ajoutprenom" data-default="Prénom" />
        <input type="text" id="ajoutnom" data-default="Nom" />
      </p>
      <p>
        <input type="text" id="ajoutcourriel" data-default="Courriel" />
      </p>
      <p>
        <input id="ajoutprovenance" data-default="Provenance" type="text">
      </p>
      <p>
        <input type="checkbox" checked="true" id="ajoutlistedenvoi" /><label for="ajoutlistedenvoi">Ajouter à la liste d'envoi: oui</label>
      </p>
      <p>
        <input type="submit" value="Envoyer" id="ajoutenvoyer" />
      </p>
    </form>
  </div>
  <div id="loading" style="text-align: center">
    <img src="/static/loading.gif" />
  </div>
  <div>
    <table id="membres">
      <thead>
         <tr>
           <th data-column="numero">#</th>
           <th data-column="prenom">Prénom</th>
           <th data-column="nom">Nom</th>
           <th data-column="courriel">Courriel</th>
           <th data-column="provenance">Provenance</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
{% endblock %}
