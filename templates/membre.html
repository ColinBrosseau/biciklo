{% extends "layout.html" %}
{% block head_extra %}
<script type="text/javascript">
  function AfficherCacherBoutons() {
    $('#annuler').toggle();
    $('#sauvegarder').toggle();
    $('#modifier').toggle();
  }

  function InstallGlobalKeypressNormal() {
    $(document).unbind('keypress');
    $(document).unbind('keydown');
    $(document).keypress(function (event) {
      if (event.which == 109) { // 'm'
        Modifier();
      }
    });
  }

  function InstallGlobalKeypressEdit() {
    $(document).unbind('keypress');
    $(document).unbind('keydown');
    $(document).keydown(function (event) {
      if (event.which == 27) { // echap
        Annuler();
      } else if (event.which == 13) {
        Sauvegarder();
      }
    });
  }

  function Modifier() {
    InstallGlobalKeypressEdit();
    AfficherCacherBoutons();

    RemplacerParInputText($('#prenom'));
    RemplacerParInputText($('#nom'));

    // Bug: quand on appuie sur m, ça met un m dans la premiere case...
    //$('#detailsmembre input').first().focus();
  }

  function Sauvegarder() {
  
    put_data = {
      'prenom': $('#prenom_input').val(),
      'nom': $('#nom_input').val(),
    };
  
    numero = $('#numero').text();

    $.ajax({
      url: '/api/membres/' + numero,
      type: 'PUT',
      data: put_data,
      success: function (result) {
        InstallGlobalKeypressNormal();
        AfficherCacherBoutons();
        RemettreTexte($('#prenom'), true);
        RemettreTexte($('#nom'), true);
      }
    });


  }

  function Annuler() {
    InstallGlobalKeypressNormal();
    AfficherCacherBoutons();
    RemettreTexte($('#prenom'), false);
    RemettreTexte($('#nom'), false);
  }

  function RemplacerParInputText(cellule) {
    val = cellule.text();
    cellule.empty();

    field = $('<input type="text" />');
    field.val(val);
    field.prop('id', cellule.prop('id') + '_input');

    cellule.prop('data-original', val);
    cellule.append(field);
  }

  function RemettreTexte(cellule, utiliser_nouvelle_valeur) {
    if (utiliser_nouvelle_valeur) {
      val = cellule.find('input').val();
    } else {
      val = cellule.prop('data-original');
    }

    cellule.empty();
    cellule.removeProp('data-original');
    cellule.text(val);
    return val;
  }

  function RemettreNouveauTexte(cellule) {
    val = cellule.find('input').val();

    cellule.empty();
    cellule.text(val);
  }

  $(document).ready(function() {
    $('#retourliste').button();
    $('#modifier').button().click(Modifier);
    $('#sauvegarder').button().click(Sauvegarder);
    $('#annuler').button().click(Annuler);
    InstallGlobalKeypressNormal();
  });

</script>

{% endblock %}
{% block content %}
  <h1>Membre :  {{ membre.prenom }} {{ membre.nom  }}</h1>
  <p>
    <a href="/membres" id="retourliste">Retour à la liste</a>&nbsp;
    <a href="#" id="modifier">Modifier</a>
    <a href="#" id="sauvegarder" style="display: none;">Sauvegarder</a>
    <a href="#" id="annuler" style="display: none;">Annuler</a>
  </p>
  <p>
  <strong>m</strong> - modifier, <strong>entrée</strong> - sauvegarder, <strong>échap.</strong> - annuler
  </p>
  <p>
    <table id="detailsmembre">
      <tbody>
        <tr class="even">
         <td class="cle">Numéro</td>
         <td class="valeur" id="numero">{{ membre.numero }}</td>
        </tr>
        <tr class="odd">
          <td class="cle">Prénom</td>
          <td class="valeur" id="prenom">{{ membre.prenom }}</td>
        </tr>
        <tr class="even">
          <td class="cle">Nom</td>
          <td class="valeur" id="nom">{{ membre.nom }}</td>
        </tr>
        <tr class="odd">
          <td class="cle">Type d'abonnement</td>
          <td class="valeur">{{ membre.type }}</td>
        </tr>
      </tbody>
    </table>
  </p>
{% endblock %}
