{% extends "layout.html" %}
{% block head_extra %}
<link href="/static/css/membre.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">

  function RaccourcisClavierModeNormal() {
    SupprimerRaccourcisClavier();

    $(document).keypress(function (event) {
      if (event.which == 109) { // 'm'
        event.preventDefault();
        ModeModification();
      }
    });
  }

  function RaccourcisClavierModeModification() {
    SupprimerRaccourcisClavier();

    $(document).keydown(function (event) {
      if (event.which == 27) { // echap
        event.preventDefault();
        Annuler();
      } else if (event.which == 13) {
        event.preventDefault();
        Sauvegarder();
      }
    });
  }

  function ModeModification() {
    $('#annuler').show();
    $('#sauvegarder').show();
    $('#modifier').hide();

    RaccourcisClavierModeModification();

    NormalVersEdition();
  }

  function ModeNormal(sauvegarder) {
    $('#annuler').hide();
    $('#sauvegarder').hide();
    $('#modifier').show();

    RaccourcisClavierModeNormal();

    EditionVersNormal(sauvegarder);
  }

  function NormalVersEdition() {
    $('#detailsmembre td[data-edit="text"]').each(function (index, cellule) {
      fixe = $(cellule).find('span');
      champ = $(cellule).find('input[type="text"]');

      champ.val(fixe.text());

      champ.show();
      fixe.hide();
    });

    $('#detailsmembre td[data-edit="radio"]').each(function (index, cellule) {
      fixe = $(cellule).find('span');
      champs = $(cellule).find('input[type="radio"]');
      labels = $(cellule).find('label');

      for (i = 0; i < champs.length; i++) {
        champ = champs[i];
        if ($(champ).val() == fixe.text()) {
          $(champ).click();
        }
      }

      labels.show();
      champs.show();
      fixe.hide();
    });
  }

  function EditionVersNormal(sauvegarder) {
    $('#detailsmembre td[data-edit="text"]').each(function (index, cellule) {
      fixe = $(cellule).find('span');
      champ = $(cellule).find('input[type="text"]');

      if (sauvegarder) {
        fixe.text(champ.val());
      }

      champ.hide();
      fixe.show();
    });

    $('#detailsmembre td[data-edit="radio"]').each(function (index, cellule) {
      fixe = $(cellule).find('span');
      champs = $(cellule).find('input[type="radio"]');
      labels = $(cellule).find('label');

      if (sauvegarder) {
        fixe.text(champs.filter(':checked').val());
      }

      labels.hide();
      champs.hide();
      fixe.show();
    });
  }

  function Sauvegarder() {
    donnees = {
      'prenom': $('#prenom input').val(),
      'nom': $('#nom input').val(),
      'listedenvoi': $('#listedenvoi input:checked').val(),
      'courriel': $('#courriel input').val(),
      'provenance': $('#provenance input').val(),
    };

    numero = $('#numero').text().trim();

    $.ajax({
      url: '/api/membres/' + numero,
      type: 'PUT',
      dataType: 'json',
      data: donnees,
      }).done(function (data) {
      if (data.status == 'ok') {
        ModeNormal(true);
        AfficherSucces('Sauvegardé !');
      } else {
        AfficherErreur('Erreur lors de la requête: ' + data.errorstr);
      }
    }).fail(function () {
      AfficherErreur('Erreur lors de la sauvegarde.');
    });
  }

  function Annuler() {
    $('#annuler').hide();
    $('#sauvegarder').hide();
    $('#modifier').show();

    ModeNormal(false);
  }

  function Modifier() {
    ModeModification();
  }

  $(document).ready(function() {
    $('#modifier').click(Modifier);
    $('#sauvegarder').click(Sauvegarder);
    $('#annuler').click(Annuler);

    RaccourcisClavierModeNormal();
  });

</script>

{% endblock %}
{% block content %}
  <h1>Membre :  {{ membre.prenom }} {{ membre.nom  }}</h1>
  <p>
    <a class="btn btn-primary" href="/membres" id="retourliste">&#8592; Retour à la liste</a>
    <button type="button" class="btn" id="modifier">Modifier</button>
    <button type="button" class="btn btn-success" id="sauvegarder" style="display: none;">Sauvegarder</button>
    <button type="button" class="btn btn-danger" id="annuler" style="display: none;">Annuler</button>
  </p>
  <p>
  <strong>m</strong> - modifier, <strong>entrée</strong> - sauvegarder, <strong>échap.</strong> - annuler
  </p>
  <p>
    <table class="table table-striped" id="detailsmembre" style="width: auto;">
      <tbody>
        <tr>
         <td class="cle">Numéro</td>
         <td class="valeur" id="numero">
           {{ membre.numero }}
         </td>
        </tr>
        <tr>
          <td class="cle">Prénom</td>
          <td class="valeur" id="prenom" data-edit="text">
            <span>{{ membre.prenom }}</span>
            <input type="text" style="display: none;" />
          </td>
        </tr>
        <tr>
          <td class="cle">Nom</td>
          <td class="valeur" id="nom" data-edit="text">
            <span>{{ membre.nom }}</span>
            <input type="text" style="display: none;" />
          </td>
        </tr>
        <tr>
          <td class="cle">Courriel</td>
          <td class="valeur" id="courriel" data-edit="text">
            <span>{{ membre.courriel }}</span>
            <input type="text" style="display: none;" />
          </td>
        </tr>
        <tr>
          <td class="cle">Liste d'envoi</td>
          <td class="valeur" id="listedenvoi" data-edit="radio">
            <span>{{ membre.listedenvoi }}</span>
            <label style="display: none;" class="radio inline"><input type="radio" class="radio" name="listedenvoi" value="oui" id="listedenvoi-oui" />oui</label>
            <label style="display: none;" class="radio inline"><input type="radio" class="radio inline" name="listedenvoi" value="non" id="listedenvoi-non" />non</label>
            <label style="display: none;" class="radio inline"><input type="radio" class="radio inline" name="listedenvoi" value="fait" id="listedenvoi-fait" />fait</label>
          </td>
        </tr>
        <tr>
          <td class="cle">Provenance</td>
          <td class="valeur" id="provenance" data-edit="text">
            <span>{{ membre.provenance }}</span>
            <input type="text" style="display: none;" />
          </td>
        </tr>
      </tbody>
    </table>
  </p>
{% endblock %}
